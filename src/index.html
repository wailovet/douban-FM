
<meta charset="utf-8" />
<script src="./jquery.js"></script>
<script src="./jquery.color.js"></script>
<link rel="stylesheet" type="text/css" href="./iconfont.css"/>
<style type="text/css">
	.bg {
		background: #ffffff;
		width: 512px;
		height: 246px;
		box-shadow: 0px 0px 13px #D8D8D8;
		padding: 0px;
	}
	@font-face {
		font-family: 'iconfont';
	    url('./iconfont.woff') format('woff'), /* chrome、firefox */
	}
	.iconfont{
	    font-family:"iconfont" !important; 
	    font-size:30px;font-style:normal;
	    -webkit-font-smoothing: antialiased; 
	    -webkit-text-stroke-width: 0.2px;
	    -moz-osx-font-smoothing: grayscale;
	    -webkit-user-select: none;
    }
    .iconfont:hover{
		color: rgb(102,102,102);
		cursor:pointer;
	}
	.music-img{
		width: 246px;
		height: 246px;
	}
	.music-npause {
	  width: 266px;
	  position: absolute;
	  height: 246px;
	  background: rgba(255,255,255,0.7);
	  top: 8px;
	  left: 254px;
	  z-index: 9999;
	  display:none;
	  font-size: 13px;
	}
	.music-npause:hover{
		color: rgba(0,0,0,0.7);
		cursor:pointer;
	}
	*{
		
		font-family: "微软雅黑";
	}
	.music-artist{
		position: absolute;
		top: 18px;
		left: 272px;
		font-size: 24px;
		font-weight: inherit;
		display: block;
		-webkit-margin-before: 0.67em;
		-webkit-margin-after: 0.67em;
		-webkit-margin-start: 0px;
		-webkit-margin-end: 0px;
	}
	.music-albumtitle{
		position: absolute;
		top: 52px;
		left: 272px;
		font-size: 13px;
		font-weight: inherit;
		display: block;
		-webkit-margin-before: 0.83em;
		-webkit-margin-after: 0.83em;
		-webkit-margin-start: 0px;
		-webkit-margin-end: 0px;
	}
	.music-title{
		position: absolute;
		top: 88px;
		left: 275px;
		font-size: 13px;
		font-weight: inherit;
		color: rgb(51,173,133); 
		display: block;
		-webkit-margin-before: 1em;
		-webkit-margin-after: 1em;
		-webkit-margin-start: 0px;
		-webkit-margin-end: 0px;
	}
	.music-public_time{
	  font-size: 11px;
	  font-weight: inherit;
	  display: inline;
		color: rgb(102,102,102);
	}
	.progressbar,.progressbar-bg{  
		width: 227px;
	  	height: 2px;
	 	background: rgb(157,214,192);
	 	position: absolute;
	 	top: 124px;
	 	left: 274px;
	 	z-index: 8888;
	}
	.progressbar-bg{
	 	background: rgb(229,229,232);
	}
	.music-pause {
	  position: absolute;
	  top: 8px;
	  left: 480px;
	  width: 10px;
	  height: 10px;
	  padding:8px;
	  background: rgb(157,214,192);
  }
  
	.music-pause:hover{
		
		cursor:pointer;
		background: rgba(157,214,192,0.8);
	}
	.music-time{
	  position: absolute;
	  top: 130px;
	  left: 467px;
	  color: #888888;
	  font-size: 11px;
	}
</style>
<body>
	
	<div id="bg" class="bg">
		<div id="music-img" class="music-img"></div>
		<div id="music-npause" class="music-npause">
		
			<p style="z-index:99999;  width: 100%;  text-align: center;  margin-top:40%;">继续收听　></p>
		</div>
		<p id="music-artist" class="music-artist"></p>
		<p id="music-albumtitle" class="music-albumtitle"></p>
		<p id="music-title" class="music-title"></p>
		<div id="music-time" class="music-time">-00:00</div>
		<a id="music-pause" href="javascript:pauseMusic();" class="music-pause" >
			<div style="width:100%;height:100%;background:#fff;"><div style="background: rgb(157,214,192);width:auto;height:100%;margin-left:3px;margin-right:3px;"></div></div>
		</a>
		
		<div class='progressbar-bg' id='progressbar-bg'></div>
		<div class='progressbar' id='progressbar'></div>
		<i id="mark" class="iconfont" style="position: absolute;top:190;left: 350;">&#xe62a;</i>
		<i class="iconfont" style="position: absolute;top:190;left: 410;">&#xe6cd;</i>
		<i id="next" class="iconfont" style="position: absolute;top:190;left: 470;">&#xe6d2;</i>
	</div>
	<audio id="audio" src="">

</audio>

<script type="text/javascript">
var SupperyStorage = function(){
}
SupperyStorage.prototype = {
	set:function(key,data){
		var str = JSON.stringify(data); 
		localStorage[key] = str;
	},
	get:function(key){
		var obj;
		try{
			obj =  JSON.parse(localStorage[key]); 
		}catch(e){
			obj = new Array();
		}
		return obj;
	}
}

</script>


<script type="text/javascript">
	var json;
	var audio;
	var gui;
	
	var supperyStorage = new SupperyStorage();
	var mylike = supperyStorage.get('mylike');
	
	$(document).ready(function(){
            gui = require('nw.gui');
			audio = document.getElementById('audio');
			nextMusic();
	});

	function pauseMusic(){
		audio.pause();
		$('.music-npause').show();
	}
	$('.music-npause').click(function(){
		$('.music-npause').hide();
		audio.play();
	});	
	
	var _mark_c=false;
	$('#mark').click(function(){
		if(_mark_c == false){
			_mark_c = true;
			$(this).animate({color:'#FFA6A6'});
			mylike.push(json.song[0]);
			supperyStorage.set('mylike',mylike);
		}else{
			_mark_c = false;
			$(this).animate({color:'#000000'});
			mylike.pop();
			supperyStorage.set('mylike',mylike);
		}
	});
	
	
	$('#next').click(function(){
		$('#mark').css({color:'#000000'}); 
		_mark_c=false;
		nextMusic();
	});
	
	
	function nextMusic(){
		$.get("http://douban.fm/j/mine/playlist?channel="+parseInt(Math.random()*100)+"&from=mainsite&type=n",function(data,status){
	    	json = data;
			if(json.song.length==0){
				nextMusic();
				return;
			}
			$("#music-img").css({background:"url('"+json.song[0].picture+"')"});
			$("#music-artist").text(json.song[0].artist);
			$("#music-albumtitle").html('\< '+json.song[0].albumtitle+' \>'+'<p id="music-public_time" class="music-public_time"></p>');
			$("#music-public_time").text(' '+json.song[0].public_time);
			$("#music-title").text(json.song[0].title);
			
			audio.src = json.song[0].url; 
			audio.play();
			audio.ontimeupdate = function(){
				var i = audio.currentTime/audio.duration;
				var w = $('#progressbar-bg').width()*i ;
				$('#progressbar').css({width:w});
				var remain = parseInt(audio.duration - audio.currentTime);
				var min = parseInt(remain/60);
				var sec = parseInt(remain%60);
				if(min<10)min = '0'+min;
				if(sec<10)sec = '0'+sec;
				var timeStr = '-'+min+':'+sec
				$('#music-time').text(timeStr);
			}

		});
	}
	
	var _x,_y,_c=false;
	document.onmousedown = function(e){
		_x = e.screenX-gui.Window.get().x;
		_y = e.screenY-gui.Window.get().y;
		_c = true;
	}
	document.onmousemove = function(e){
		if(e.clientX>512||e.clientY>246||e.clientY<10){
			autoHide();
		}else{	
			autoShow();
		}
		if(_c==true){
			gui.Window.get().moveTo(e.screenX-_x, e.screenY-_y);
		}
	}
	
	
	document.onmouseup = function(e){
		_c  = false;
		auto_hide = false;
		if(e.screenX-_x<0){
			gui.Window.get().moveTo(0,e.screenY-_y);
			auto_hide = true;
			autoHide();
		}
	}
	
	
	var auto_hide=false;
	var auto_hide_type = 0;
	function autoHide(){
		if(auto_hide==false)return;
		if(auto_hide_type!=0)return;
		if( gui.Window.get().x >-510){
			gui.Window.get().x=gui.Window.get().x-10;
			setTimeout("autoHide()",10);
		}else{
			auto_hide_type = 1;
		}
	}
	function autoShow(){
		if(auto_hide==false)return;
		if(auto_hide_type!=1)return;
		if( gui.Window.get().x <-40){
			gui.Window.get().x=gui.Window.get().x+20;
			setTimeout("autoShow()",50);
		}else{
			auto_hide_type = 0;
		}
	}	
	
	
</script>
</body> 